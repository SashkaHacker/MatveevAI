# Отчет по лабораторной работе №00

# Установка PostgreSQL и базовое управление сервером

  

## Сведения о студенте

**Дата:** 2025-09-10
**Семестр:** 7
**Группа:** ПИЖ-б-о-22-1
**Дисциплина:** Администрирование баз данных
**Студент:** Матвеев Александр Иванович

  

## Цель работы
Познакомиться с процессом установки и базового администрирования СУБД PostgreSQL.
**Научиться:**
* устанавливать PostgreSQL из пакетов и из исходных кодов;
* управлять кластерами баз данных (запуск, остановка, перезапуск);
* включать контрольные суммы (`pg_checksums`) для защиты данных;
* выполнять подключение к серверу и проверочные SQL-запросы;
* анализировать различия между установкой из пакетов и из исходников.

## Теоретическая часть
### Изученные концепции
* **Кластеры PostgreSQL:** набор баз данных, управляемых одним экземпляром сервера.
* **Контрольные суммы страниц данных:** механизм проверки целостности данных на уровне физических страниц.
* **Управление сервером:** операции `start`, `stop`, `restart`, `status` через `pg_ctlcluster` и `pg_ctl`.

### Ключевые термины
* **Cluster:** логическая единица, включающая в себя все базы данных PostgreSQL, файлы конфигурации и WAL.
* **pg_checksums:** утилита для проверки и включения контрольных сумм данных в кластере.
* **initdb:** программа для инициализации нового кластера баз данных.
* **pg_ctl:** инструмент управления сервером PostgreSQL (запуск, остановка, проверка статуса).

## Практическая часть

### Модуль 1: Установка PostgreSQL из пакетов

#### Задача 1: Установка и первичная проверка
**Цель:** установить PostgreSQL 16 и убедиться, что кластер создан.

**Выполненные действия:**
  
```bash
sudo apt update
sudo apt install -y postgresql-16 postgresql-client-16 postgresql-common
pg_lsclusters
```

**Результаты:**
```bash
Ver Cluster Port Status Owner    Data directory                 Log file
16  main    5432 online postgres /var/lib/postgresql/16/main    /var/log/postgresql/postgresql-16-main.log
16  replica 5433 down   postgres /var/lib/postgresql/16/replica /var/log/postgresql/postgresql-16-replica.log
```

**Выводы и объяснения:**
Кластер `16 main` был автоматически создан при установке пакета. Статус `online` подтверждает, что сервер успешно запущен. Кластер `replica` может оставаться выключенным.

#### Задача 2: Включение контрольных сумм
**Цель:** активировать контрольные суммы страниц данных для проверки целостности БД.

**Выполненные действия:**
```bash
sudo pg_ctlcluster 16 main stop
sudo -u postgres /usr/lib/postgresql/16/bin/pg_checksums --check -D /var/lib/postgresql/16/main
sudo -u postgres /usr/lib/postgresql/16/bin/pg_checksums --enable -D /var/lib/postgresql/16/main
sudo pg_ctlcluster 16 main start
```

**Результаты:**
```bash
var/lib/postgresql/16/main
Checksum operation completed
Files scanned:   1244
Blocks scanned:  3757
Bad checksums:  0
Data checksum version: 1
```

**Выводы и объяснения:**
После остановки кластера контрольные суммы были успешно включены. Это повышает устойчивость системы к повреждениям страниц данных.

#### Задача 3: Управление сервером
**Цель:** освоить базовые команды управления кластером.

**Выполненные действия:**
```bash
sudo pg_ctlcluster 16 main stop
sudo pg_ctlcluster 16 main status
sudo pg_ctlcluster 16 main start
sudo pg_ctlcluster 16 main status
sudo pg_ctlcluster 16 main restart
sudo pg_ctlcluster 16 main status
```

**Результаты:**
```bash
pg_ctl: no server running

pg_ctl: server is running (PID: 4951)
/usr/lib/postgresql/16/bin/postgres "-D" "/var/lib/postgresql/16/main" "-c" "config_file=/etc/postgresql/16/main/postgresql.conf"

pg_ctl: server is running (PID: 5002)
/usr/lib/postgresql/16/bin/postgres "-D" "/var/lib/postgresql/16/main" "-c" "config_file=/etc/postgresql/16/main/postgresql.conf"
```

**Вывод:**
Команды `pg_ctlcluster` позволяют администратору управлять процессом сервера PostgreSQL без прямого обращения к `pg_ctl`.

#### Задача 4: Проверка версии PostgreSQL
**Цель:** убедиться в корректной работе сервера.

**Выполненные действия:**
```bash
sudo -u postgres psql -c "SELECT version();"
```

**Результаты:**
```bash
PostgreSQL 16.10 (Ubuntu 16.10-1.pgdg24.04+1) on aarch64-unknown-linux-gnu, compiled by gcc (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0, 64-bit
```

**Вывод:**
Сервер PostgreSQL 16 успешно функционирует.

---

### Модуль 2: Установка PostgreSQL из исходных кодов

#### Задача 1: Сборка и установка
**Цель:** собрать PostgreSQL из исходников в пользовательский каталог с нестандартным портом.

**Выполненные действия:**
```bash
sudo apt install -y build-essential libreadline-dev zlib1g-dev flex bison gettext libssl-dev
```

**Результаты:**

```bash
ison gettext libssl-dev
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
build-essential is already the newest version (12.10ubuntu1).
...
```

**Вывод:**
Все инструменты для выполнения установки PostgreSQL 16 из исходных кодов имеются на виртуальной машине.

#### Задача 2: Сборка
**Цель:** собрать PostgreSQL из исходников в пользовательский каталог.

**Выполненные действия:**
```bash
mkdir -p ~/src && cd ~/src
wget https://ftp.postgresql.org/pub/source/v16.4/postgresql-16.4.tar.gz
tar xf postgresql-16.4.tar.gz && cd postgresql-16.4
./configure --prefix=$HOME/pg16 --with-pgport=5435
make -j2
make install
```

**Вывод:**
В ходе данной задачи мы создали новую папку, скачали архив с сайта postgresql при помощи утилиты `wget` и распаковали его в директорию `postgresql-16.4`, запустили `./configure` с ключами `--prefix и --with-pgport` для того, чтобы указать пользовательский путь установки и порт, на котором будет работать PostgreSQL.

---
#### Задача 3: Создание кластера
**Цель:** создать новый кластер данных.

**Выполненные действия:**
```bash
mkdir -p ~/pgdata16
~/pg16/bin/initdb -D ~/pgdata16 --username=postgres --data-checksums
```

**Результаты:**

```bash
The files belonging to this database system will be owned by user "student".
This user must also own the server process.

The database cluster will be initialized with this locale configuration:
  provider:    libc
  LC_COLLATE:  en_US.UTF-8
  LC_CTYPE:    en_US.UTF-8
  LC_MESSAGES: en_US.UTF-8
  LC_MONETARY: ru_RU.UTF-8
  LC_NUMERIC:  ru_RU.UTF-8
  LC_TIME:     ru_RU.UTF-8
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are enabled.

fixing permissions on existing directory /home/student/pgdata16 ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Europe/Moscow
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok

initdb: warning: enabling "trust" authentication for local connections
initdb: hint: You can change this by editing pg_hba.conf or using the option -A, or --auth-local and --auth-host, the next time you run initdb.

Success. You can now start the database server using:

    /home/student/pg16/bin/pg_ctl -D /home/student/pgdata16 -l logfile start
```

```bash
waiting for server to start.... done
server started
```

**Вывод:**
Собранный вручную сервер успешно запущен на порту 5435 и корректно выполняет запросы.

---
#### Задача 4: Запуск и проверка
**Цель:** Проверка работоспособности.

**Выполненные действия:**
```bash
~/pg16/bin/pg_ctl -D ~/pgdata16 -l ~/pg16/pg.log start
~/pg16/bin/psql -p 5435 -U postgres -d postgres -c "SELECT version();"
~/pg16/bin/pg_ctl -D ~/pgdata16 stop -m fast
```

**Результаты:**
```bash
waiting for server to start.... done
server started
```

```bash
 PostgreSQL 16.4 on aarch64-unknown-linux-gnu, compiled by gcc (Ubuntu 13.3.0-6ubu
ntu2~24.04) 13.3.0, 64-bit
```

```bash
waiting for server to shut down.... done
server stopped
```

**Вывод:**
Собранный вручную сервер успешно запущен/остановлен на порту 5435 и корректно выполняет запросы.

---

## Анализ и выводы

### Основные наблюдения

1. Установка из пакетов выполняется быстрее и автоматически создаёт кластер.
2. Включение контрольных сумм возможно только при остановленном сервере.
3. Сборка из исходников требует множество зависимостей, но позволяет задавать порт, префикс и опции компиляции.

### Сравнительный анализ

| Критерий                 | Установка из пакетов | Установка из исходников |
| ------------------------ | -------------------- | ----------------------- |
| Простота                 | Очень высокая        | Средняя                 |
| Гибкость                 | Низкая               | Высокая                 |
| Время установки          | Минимальное          | Существенно больше      |
| Настройка окружения      | Автоматическая       | Ручная                  |
| Возможность кастомизации | Ограниченная         | Полная                  |

---

## Ответы на контрольные вопросы

1. **Для чего нужны контрольные суммы страниц данных?**
   Контрольные суммы позволяют PostgreSQL обнаруживать повреждения файлов базы данных на уровне страниц и предотвращать использование некорректных данных.

2. **Чем отличается установка PostgreSQL из пакетов и из исходников?**
   Установка из пакетов — быстрая и стандартная, но менее гибкая. Установка из исходников требует сборки и настройки вручную, зато даёт контроль над параметрами и портом.

3. **Какие команды используются для управления кластером?**
   Для системных установок: `pg_ctlcluster`; для пользовательских: `pg_ctl`.

