# Отчет по лабораторной работе №01

# Архитектура СУБД и конфигурация


## Сведения о студенте
**Дата:** 2025-09-10
**Семестр:** 7
**Группа:** ПИЖ-б-о-22-1
**Дисциплина:** Администрирование баз данных
**Студент:** Матвеев Александр Иванович


## Цель работы
Изучить базовые компоненты архитектуры PostgreSQL (процессы, память) и получить практические навыки управления конфигурационными параметрами сервера на разных уровнях (экземпляр, сеанс). Освоить работу с основными и дополнительными файлами конфигурации, а также с представлениями `pg_settings` и `pg_file_settings`.
**Научиться:**
* освоить работу с основными и дополнительными файлами конфигурации;
* работать с представлениями `pg_settings` и `pg_file_settings`.


## Теоретическая часть
### Изученные концепции
* **Кластеры PostgreSQL:** набор баз данных, управляемых одним экземпляром сервера.
* **Контрольные суммы страниц данных:** механизм проверки целостности данных на уровне физических страниц.
* **Управление сервером:** операции `start`, `stop`, `restart`, `status` через `pg_ctlcluster` и `pg_ctl`.

### Ключевые термины
* **postgresql.conf:** основной файл конфигурации, который считывается при запуске сервера, может редактироваться вручную или при помощи расширяемых файлов.
* **postgresql.auto.conf:** файл, который автоматически генерируется при выполнении команды `ALTER SYSTEM SET`, управление происходит через неё же. Имеет больший приоритет, чем основной файл конфигурации.

## Практическая часть

### Модуль 1: Исследование параметров и файлов конфигурации

#### Задача 1: Текущая конфигурация
**Цель:** поиск основного файла конфигурации.

**Выполненные действия:**
Запуск и подключение к серверу через команду:
```bash
psql -d student
```
Выполнение SQL запроса в среде psql:
```sql
SHOW config_file;
```

**Результаты:**
```sql
 /etc/postgresql/16/main/postgresql.conf
(1 row)
```

**Выводы и объяснения:**
Мы увидели путь, по которому находится основной файл конфигурации.

#### Задача 2: Анализ параметров
**Цель:** Найдите параметры, для изменения которых требуется перезагрузка сервера `(context = 'postmaster')`. Найдите 2-3 параметра с контекстом `sighup` и `user`.

**Выполненные действия:**
Нахождение параметров, для которых требуется перезагрузка сервера:
```bash
SELECT name, setting, context FROM pg_settings WHERE context = 'postmaster' ORDER BY name LIMIT 10;
```

Нахождение параметров с контекстом `sighup` и `user`:
```sql
SELECT name, context FROM pg_settings WHERE context IN ('sighup','user') LIMIT 3;
```

**Результаты:**
Вывод параметров, для которых требуется перезагрузка:
<pre>                name                 |                 setting                 |  context   
-------------------------------------+-----------------------------------------+------------
 archive_mode                        | off                                     | postmaster
 autovacuum_freeze_max_age           | 200000000                               | postmaster
 autovacuum_max_workers              | 3                                       | postmaster
 autovacuum_multixact_freeze_max_age | 400000000                               | postmaster
 bonjour                             | off                                     | postmaster
 bonjour_name                        |                                         | postmaster
 cluster_name                        | 16/main                                 | postmaster
 config_file                         | /etc/postgresql/16/main/postgresql.conf | postmaster
 data_directory                      | /var/lib/postgresql/16/main             | postmaster
 data_sync_retry                     | off                                     | postmaster
(10 rows)</pre>
Вывод параметров с контекстом `sighup` и `user`:
<pre>          name           | context 
-------------------------+---------
 archive_cleanup_command | sighup
 archive_command         | sighup
 archive_library         | sighup
</pre>


**Выводы и объяснения:**
Были успешно выведены требуемые параметры при помощи соответствующих sql запросов.

#### Задача 3: Анализ файлов
**Цель:** Изучите представление `pg_file_settings`. Определите, из каких файлов и с какими значениями были считаны текущие настройки параметров `shared_buffers` и `work_mem`.

**Выполненные действия:**
```bash
SELECT sourcefile, sourceline, name, setting, applied, error
FROM pg_file_settings
WHERE name IN ('shared_buffers','work_mem');
```

**Результаты:**
<pre>               sourcefile                | sourceline |      name      | setting | applied | error 
-----------------------------------------+------------+----------------+---------+---------+-------
 /etc/postgresql/16/main/postgresql.conf |        130 | shared_buffers | 128MB   | t       | 
(1 row)
</pre>

**Вывод:**
В результате мы узнали, что настройка `shared_buffers` была считана из стандартного файла конфигурации, а параметр `work_mem` ещё не был задан.

### Модуль 2: Управление параметрами на уровне экземпляра

#### Задача 1: Изменение через ALTER SYSTEM
**Цель:** Используя команду `ALTER SYSTEM`, установите для параметра
`work_mem` новое значение. Убедитесь, что изменение записалось в файл `postgresql.auto.conf` (используйте функцию `pg_read_file`). Примените изменение, перечитав конфигурацию (`SELECT pg_reload_conf();`). Проверьте новое значение параметра и его источник в `pg_settings`.

**Выполненные действия:**
Установили новое значение:
```sql
ALTER SYSTEM SET work_mem="64MB";
```
Проверка, что значение установилось:
```sql
SELECT pg_read_file('postgresql.auto.conf');
```
Применение изменений:
```sql
SELECT pg_reload_conf();
```
Проверка значение и источника:
```sql
SELECT name, setting, source, sourcefile
FROM pg_settings
WHERE name = 'work_mem';
```


**Результаты:**
Вывод содержимого файла `postgresql.auto.conf`
```sql
                     pg_read_file                      
-------------------------------------------------------
 # Do not edit this file manually!                    +
 # It will be overwritten by the ALTER SYSTEM command.+
 work_mem = '64MB' 
```
Применение изменений:
```sql
 pg_reload_conf 
----------------
 t
(1 row)
```
Проверка значение и источника:
<pre>   name   | setting |       source       |                    sourcefile                    
----------+---------+--------------------+--------------------------------------------------
 work_mem | 65536   | configuration file | /var/lib/postgresql/16/main/postgresql.auto.conf
(1 row)
</pre>

**Вывод:**
В результате мы успешно изменили параметр `work_mem` и применили все проделанные изменения.

#### Задача 2: Изменение через дополнительный файл
**Цель:** Создайте файл в каталоге, указанном в директиве `include_dir` основного конфигурационного файла. Установите в этом файле значение для параметра `log_min_duration_statement`. Примените изменение и проверьте его.

**Выполненные действия:**
Создание нового файла в директории `conf.d`, которая указана в параметре `include_dir` конфигурационного файла:
```bash
sudo touch new_log.conf
```
Запись в этот файл параметра `log_min_duration_statement` = 250ms
Применение изменений:
```sql
SELECT pg_reload_conf();
```
Проверка значения параметра:
```sql
SHOW log_min_duration_statement;
```

**Результаты:**
```sql
 pg_reload_conf 
----------------
 t
(1 row)
```
Вывод проверки значения:
```sql
 log_min_duration_statement 
----------------------------
 250ms
(1 row)
```

**Вывод:**
В ходе данной задачи мы создали новую папку, скачали архив с сайта postgresql при помощи утилиты `wget` и распаковали его в директорию `postgresql-16.4`, запустили `./configure` с ключами `--prefix и --with-pgport` для того, чтобы указать пользовательский путь установки и порт, на котором будет работать PostgreSQL.

---
#### Задача 3: Ошибка в конфигурации
**Цель:** Намеренно внесите синтаксическую ошибку в один из конфигурационных файлов (например, `invalid_value` вместо числового значения). Попытайтесь перечитать конфигурацию. Изучите представление `pg_file_settings`, чтобы найти запись об ошибке. Исправьте ошибку и перечитайте конфигурацию.

**Выполненные действия:**
Внесённые некорректные данные:
```bash
work_mem = invalid_integer
```
Применение изменений:
```sql
SELECT pg_reload_conf();
```
Просмотр представления `pg_file_settings`:
```sql
SELECT * FROM pg_file_settings;
```
Исправление ошибки.
```bash
work_mem = 64MB
```

**Результаты:**
Ошибка в представлении `pg_file_settings`:
```bash
 /etc/postgresql/16/main/conf.d/new_log.conf |          2 |    28 | work_mem                   | invalid_integer                        | f       | setting could not be applied
```
Представление после исправления ошибки:
```bash
 /etc/postgresql/16/main/conf.d/new_log.conf |          2 |    28 | work_mem                   | 64MB                                   | t       | 
```

### Модуль 3: Управление параметрами на уровне сеанса

#### Задача 1: Команда SET
**Цель:** В рамках сеанса измените значение параметра `work_mem` с помощью `SET`. Проверьте новое значение. Завершите транзакцию с помощью `ROLLBACK` и проверьте значение параметра again. Объясните результат.

**Выполненные действия:**
Установили новое значение для текущего сеанса:
```sql
SET work_mem = '32MB';
```
Проверка, что значение установилось:
```sql
SHOW work_mem;
```
Откат изменения:
```sql
ROLLBACK;
```
Проверка, что значение параметра откатилось:
```sql
SHOW work_mem;
```


**Результаты:**
Так как мы использовали изменяли значение в рамках сеанса, то команда `ROLLBACK` не смогла восстановить прежние настройки параметра из-за того, что она работает с транзакциями.

**Вывод:**
В результате мы успешно изменили параметр `work_mem` и применили все проделанные изменения.

---

## Ответы на контрольные вопросы

- `postmaster`: изменения применяются только после *перезапуска* сервера (например, `shared_buffers`, `max_connections`).
- `sighup`: достаточно перечитать конфигурацию (`SELECT pg_reload_conf();`), перезапуск не нужен (например, `log_min_duration_statement`).
- `user`: можно менять на лету на уровне сеанса (`SET`), без перезагрузки и перечитывания (например, `work_mem`).
